---
title:  "Basic Goodness-of-fit Diagnostic Plots"
author: "Certara PMxO R Tools Workstream"
date:   "`r format(Sys.Date(), '%d-%b-%Y')`"
output: rmarkdown::html_vignette
    
vignette: >
  %\VignetteIndexEntry{Basic Goodness-of-fit Diagnostic Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
table {
    font-family: "Arial", Arial, sans-serif;
    font-size: 10pt;
    border-collapse: collapse;
    padding: 0px;
    margin: 0px;
    width: 100%;
    display: block;
    overflow: auto;
}
</style>

```{css echo=FALSE}
/* Define a margin before h1 element */
h1  {
  margin-top: 3em;
}
h2  {
  margin-top: 2em;
}
h3  {
  margin-top: 1em;
}
``` 

```{r echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=TRUE, comment="#>", dpi=300, out.width="80%")
```


# Setup

Before starting, load the `ggplot2` and `ggcertara` packages, and set the default `ggplot` theme to `theme_certara()`:

```{r}
suppressPackageStartupMessages({
  library(ggplot2)
  library(ggcertara)
  library(kableExtra) #used for the vignette not for ggcertara demonstration
})
theme_set(theme_certara())
```

# Overview

the `ggcertara` package and `theme_certara` theme are meant to provide a standardized look to typical `gof` plots employed by pharmacometricians. The syntax is based on `ggplot2`. The `ggcertara` also utilizes the `patchwork` package and syntax. These will be touched upon later in this vignette.

# Data:

## Data Expectations
The `gof()` function uses standard column names in lower case. Not all of the following
  
  - time:   Time (e.g., time since first dose)
  - tad:    Time after dose
  - dv:     Dependent variable
  - pred:   Population prediction
  - ipred:  Individual prediction
  - cwres:  Conditional weighted residual
  - iwres:  Individual weighted residual

Not all of these need to be present, only those that are needed for the disired plots (for instance, if no plots involving IWRES are requested, then it does not need to be present). The column names must be in lower case.

## Reading: 
The `gof_read_data()` function simplifies the data loading process by:

1. loading the data
2. ensuring that all names are lower case
3. removing missing dependent variables

It is implicitly called within `gof_list()` and all `gof()` function variants when the `data` argument is not supplied. A simple heuristic search is performed within the current working directory for the first file, in order, containing the following: 

1. beginning with `sdtab*`; file that is commonly used with PsN/Xpose 
2. `*.csv` file extension (software agnostic)

While it is convenient to have the function automatically scan for data in the current working directory, this may not always be the desired approach and it is also possible to pass a standard `data.frame` to the `gof()` function via the `data` argument.

For this example, we will use some sample data that has been provided with this package and pretend that it is the result of a model fit. This file was actually generated by NONMEM (using the statement `$TABLE FILE=nmtable1.csv FORMAT=,1PE15.8 ...`).  It's contents look like this:

```{r echo=F}
knitr::kable(head(nmtable1))
```

# Basic usage

By default, the `gof()` function produces a figure with 6 panels arranged in
a 2-by-3 grid. 


```{r echo=FALSE, fig.width=6, fig.height=9, out.width="70%"}
dftemp <- data.frame(Column_1=c('DV vs. IPRED', 'DV vs. PRED'),
                 Column_2=c('CWRES vs. TIME','CWRES vs. PRED'),
                 Column_3=c('CWRES vs. TAD', '|IWRES| vs. IPRED'))
knitr::kable(dftemp,align = 'c') %>%
  column_spec(1, width = "15em", background = "white", include_thead = TRUE) %>%
  column_spec(2, width = "15em", background = "white", include_thead = TRUE) %>%
  column_spec(3, width = "15em", background = "white", include_thead = TRUE)
```

<div style="margin-bottom:20px;">
</div>

```{r fig.width=9, fig.height=6, out.width="90%"}
dat <- nmtable1
names(dat) <- tolower(names(dat))
dat <- subset(dat, mdv==0)
gof(dat) #Note: output aspect ratio is set to 3:2, in this case width=9, height=6
```

<div style="margin-bottom:20px;">
</div>

We can use the `layout` option to specify the number of rows and columns.

```{r fig.width=6, fig.height=9, out.width="60%"}
gof(dat,layout = c(3,2))
```

<div style="margin-bottom:20px;">
</div>

Note that all axes are nicely labelled (though they lack units at this point). With this simple function call, we have produced a report ready figure!

# Customizing the output

## Selecting panels

The `gof()` function can easily produce a variety of panels which can be referenced as either numbered panels,  named functions, or as strings.

```{r echo=FALSE}
dftemp <- data.frame(Number=c('1','2','3','4','5','6','7','8','9','10','11, -3','12, -4','13, -5','14, -6','15, -7','16, -8','17, -9','18, -10'),
                 'Function'=c('gof_histogram()','gof_qqplot()','gof_dv_vs_ipred()','gof_dv_vs_pred()','gof_cwres_vs_pred()','gof_cwres_vs_time()','gof_cwres_vs_tad()','gof_absiwres_vs_ipred()','gof_absiwres_vs_time()','gof_absiwres_vs_tad()','gof_dv_vs_ipred(log_xy=T)','gof_dv_vs_pred(log_xy=T)','gof_cwres_vs_pred(log_x=T)','gof_cwres_vs_time(log_x=T)','gof_cwres_vs_tad(log_x=T)','gof_absiwres_vs_ipred(log_x=T)','gof_absiwres_vs_time(log_x=T)','gof_absiwres_vs_tad(log_x=T)'),
                 Name=c('cwres_histogram','cwres_qqplot','dv_vs_ipred','dv_vs_pred','cwres_vs_pred','cwres_vs_time','cwres_vs_tad','absiwres_vs_ipred','absiwres_vs_time','absiwres_vs_tad','dv_vs_ipred_log','dv_vs_pred_log','cwres_vs_pred_log','cwres_vs_time_log','cwres_vs_tad_log','absiwres_vs_ipred_log','absiwres_vs_time_log','absiwres_vs_tad_log'),
                 Description=c('Histogram of CWRES','QQ-plot of CWRES','DV vs. IPRED','DV vs. PRED','CWRES vs. PRED','CWRES vs. TIME','CWRES vs. TAD','|IWRES| vs. IPRED','|IWRES| vs. TIME','|IWRES| vs. TAD','DV vs. IPRED log scale','DV vs. PRED log scale','CWRES vs. PRED log scale','CWRES vs. TIME log scale','CWRES vs. TAD log scale','|IWRES| vs. IPRED log scale','|IWRES| vs. TIME log scale','|IWRES| vs. TAD log scale'))
knitr::kable(dftemp,align = 'l') %>%
  column_spec(1, width = "5em", background = "white", include_thead = TRUE) %>%
  column_spec(2, width = "15em", background = "white", include_thead = TRUE) %>%
  column_spec(3, width = "15em", background = "white", include_thead = TRUE) %>%
  column_spec(4, width = "15em", background = "white", include_thead = TRUE)
```

Note that the standard 6 plots in the `gof()` function correspond to the numbered panels 3, 6, 7, 4, 5, 8 from this list.

<div style="margin-bottom:40px;">
</div>

### Calling the `panels` option within `gof()`
Using the `panels` argument, select panels can be selected using either the respective panel numbers or names (as strings).  For example, to prduce both a histogram and QQ-plot of CWRES, select panels 1 and 2 or callthem by name `cwres_histogram` and `cwres_qqplot`:

```{r fig.width=9, fig.height=3, out.width="90%"}
gof(dat, panels=1:2)
gof(dat, panels=c('cwres_histogram', 'cwres_qqplot'))
```

<div style="margin-bottom:40px;">
</div>

For log-scale plots (panels 11-18 above), we can call their panel number or add a `-` to their linear scale counterpart. For example, to obtain a plot of DV vs. IPRED on log-log scale, we can set `panel=11` or `panel=-3`:

```{r fig.width=9, fig.height=3, out.width="90%"}
gof(dat, panels=c(11,-3))
```

<div style="margin-bottom:40px;">
</div>

### Named function:

We can also call specific panels using the corresponding named function. As in the previous example, if we want either the log or log-log versions of a plot, we specify either `log_x=T` or `log_xy=T` options.

```{r fig.width=3, fig.height=3, out.width="30%"}
gof_dv_vs_ipred(dat, log_xy=T)
```

<div style="margin-bottom:40px;">
</div>

### The `gof_list` object

Individual panels can also be with the `gof_list()` fucntion. This returns a numbered list of the 6 standard default panels. By creating an object, we can call the panel number as follows:

```{r fig.width=3, fig.height=3, out.width="30%"}
p <- gof_list(dat)
p[[5]]
```

<div style="margin-bottom:40px;">
</div>

`gof_list` can also be used to build a new list of plots.

```{r fig.width=3, fig.height=3, out.width="30%"}
p <- gof_list(empty = T)
p[[1]] = gof_dv_vs_ipred(dat)
p[[2]] = gof_dv_vs_pred(dat)
p[[1]]
```

## Labels and units

There are several ways to customize the plot axis labels/units. When a recognized variable name is used in a plot (e.g. `ipred`, `cwres`, etc.), the functions will find a corresponding axis label in a list object which by default corresponds to a global option:

```{r echo=F}
dftemp <- data.frame(Option=c('gof.label.dv','gof.label.pred','gof.label.ipred','gof.label.cwres','gof.label.iwres','gof.label.time','gof.label.tad','gof.units.dv','gof.units.time','gof.units.tad'),
                 Default=c('Observed Value','Population Prediction','Individual Prediction','Conditional Weighted Residual','Individual Weighted Residual','Time','Time After Dose','NA','NA','NA'))

knitr::kable(dftemp,align = 'l',) %>%
  kable_styling(full_width = F) %>%
  column_spec(1, width = "10em", background = "white", include_thead = TRUE) %>%
  column_spec(2, width = "15em", background = "white", include_thead = TRUE)
```
Every function has a `labels` argument to override the default, should it be necessary. Also note when updating labels/units, it is not required to specify all labels/units, only the labels/units that are being updated need be specified.

<div style="margin-bottom:40px;">
</div>

### Global label/units update

We can update labels and units at the global level by calling the desired option within the `options` function. Units for concentration (dv, pred, ipred), time, and tad can also be set using global options and will be appended to the label:

```{r fig.width=9, fig.height=6, out.width="90%"}
options(gof.label.cwres = 'CWRES',
        gof.label.dv = 'MyDrug',
        gof.units.dv="ng/mL",
        gof.units.time="h",
        gof.units.tad="h")
gof(dat)
```

<div style="margin-bottom:40px;">
</div>

### Update labels for a single plot
We can update a default label for a single plot by calling the `label` option as follows.

```{r fig.width=9, fig.height=6, out.width="90%"}
gof(dat, labels = gof_labels(dv='Obs'))
```

<div style="margin-bottom:40px;">
</div>
Finally, the usual `labs()` function can be used to set or modify the labels of any plot. In this case, units do not get applied and must be explicitly included in the labels.

```{r fig.width=3, fig.height=3, out.width="30%"}
gof(dat, 6) + labs(x="Something silly", y="Why not? (light years)")
```


Now let's restore our defaults before moving on...

```{r }
# Restore defaults
options(gof.label.dv    = "Observed Value",
        gof.label.pred  = "Population Prediction",
        gof.label.ipred = "Individual Prediction",
        gof.label.cwres = "Conditional Weighted Residual",
        gof.label.iwres = "Individual Weighted Residual",
        gof.label.time  = "Time",
        gof.label.tad   = "Time After Dose",
        gof.units.dv=NA,
        gof.units.time=NA,
        gof.units.tad=NA
)
```

## Outliers

To highlight outliers using a special symbol (and color), you first define a column in the dataset which is a factor with 2 levels (be mindful of the labels, as these will appear in the legend and also note the use of unicode language for special symbols.):

```{r}
dat$outlier <- factor(abs(dat$cwres) > 2.5, labels=c("|CWRES| \U{2264} 2.5", "|CWRES| > 2.5"))
```

<div style="margin-bottom:40px;">
</div>

Then, use the `highlight` option, like this:

```{r message=F, fig.width=4, fig.height=4, out.width="30%"}

gof_cwres_vs_pred(dat, highlight=outlier) +
  scale_y_continuous(breaks = c(-2.5,0,2.5))
```

This feature should be used carefully. Note that highlighting values also populates a legend at the bottom, left corner of the plot area.

```{r fig.width=9, fig.height=10, out.width="90%"}
gof(dat, highlight=outlier)
```

## Faceting

Faceting can be applied with `facet_wrap` or `facet_grid` as with any `ggplot` object. Note that patchwork automatically creates a single legend beneath the plots.

```{r fig.width=9, fig.height=6, out.width="90%"}
dat$sex = factor(ifelse(dat$id<=60, 'Male','Female'),
                 levels = c('Female','Male'))
```

```{r message=F, fig.width=6, fig.height=4, out.width="60%"}
gof(dat,panels = 3, highlight=outlier) +
  facet_wrap(~sex)
```

## Changing aesthetics (colors, etc.)

### Alpha

Updating the alpha requires updating the global options with the `update_geom_defaults()` function. 

```{r fig.width=9, fig.height=6, out.width="90%"}
update_geom_defaults("point_c", list(alpha=0.05)) #update the global options
gof(dat)
update_geom_defaults("point_c", list(alpha=0.3)) #reset to default alpha
```

<div style="margin-bottom:40px;">
</div>

For a single panel, you can just modify the `ggplot` object. Here we update the color and size of the outliers (defined earlier).

```{r message=F, fig.width=4, fig.height=4, out.width="30%"}
gof(dat, panels=3, highlight=outlier) +
  scale_colour_manual(values=c("#7059A6", "#52ccbb")) +
  scale_shape_manual(values=c(19, 19)) +
  scale_size_manual(values=c(1, 5))
```

For a `patchwork` object (multiple panels), you can do the same thing by
replacing the `+` operator with a `&`:

```{r message=F, fig.width=6, fig.height=4, out.width="70%"}
gof(dat, panels=3:4, highlight=outlier) &
  scale_colour_manual(values=c("#7059A6", "#52ccbb")) &
  scale_shape_manual(values=c(19, 19)) &
  scale_size_manual(values=c(1, 5))
```

`patchwork` is smart enough to produce a single legend for both panels.

## Adding geoms and annotations

As with any ggplot object, geoms can be added. Remember to use the `&` operator instead of `+` when creating multiple panels.

```{r message=F,fig.width=6, fig.height=3, out.width="90%"}
gof(dat, panels=10:11) &
  geom_smooth(method="lm", color="#52ccbb", se=F, size=1)
```

Here, another dashed line with corresponding text is added to CWRES plots.

```{r fig.width=6, fig.height=3, out.width="90%"}
 gof(dat, panels = -(3:4)) &
  geom_hline(yintercept=1.2, linetype="dashed") &
  geom_text(data=data.frame(x=Inf, y=1.2), aes(x=x, y=y),
    label="LLOQ = 1.2 ng/mL", hjust=1.1, vjust=-0.5, size=3)
```

# R session information

```{r}
sessionInfo()
```



